# 审核状态同步问题修复指南

## 问题描述

**现象：**
- 用户添加游戏后，提交审核
- 审核员点击"通过审核"
- 但游戏在 `games` 表中的 `status` 字段仍然为 `'pending'`
- `is_published` 字段仍然为 `false`
- 导致游戏无法在前台显示

## 问题根源分析

### 1. 数据流程

当审核员批准游戏时，代码执行流程如下：

```
用户提交 → game_submissions 表（草稿）
         ↓
审核员批准 → Moderation.vue 的 approveContent() 函数
         ↓
1. 从 game_submissions 读取草稿数据
2. 插入到 games 表，设置 status='approved', is_published=true
3. 更新 moderation_queue 表，设置 status='approved'
         ↓
触发器被触发 → handle_moderation_decision()
         ↓
❌ 问题：触发器更新 games 表时，没有更新 is_published 字段！
```

### 2. 问题代码

**在 `message-system-setup.sql` 第173-193行：**

```sql
CREATE OR REPLACE FUNCTION handle_moderation_decision()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.status = 'pending' AND NEW.status IN ('approved', 'rejected') THEN
    IF NEW.content_type = 'game' THEN
      UPDATE public.games 
      SET status = NEW.status,
          reviewed_by = NEW.moderator_id,
          reviewed_at = now(),
          rejection_reason = NEW.rejection_reason
      WHERE id = NEW.content_id;
      -- ❌ 这里没有更新 is_published 字段！
```

### 3. 冲突的逻辑

- **前端代码**（`Moderation.vue`）：设置 `is_published = true`
- **触发器**（`handle_moderation_decision`）：更新 `games` 表但不设置 `is_published`
- **结果**：触发器可能覆盖前端设置的值，或者导致状态不一致

## 解决方案

### 核心修复

修改 `handle_moderation_decision()` 触发器函数，让它在更新 `games` 表时**同时更新 `is_published` 字段**：

```sql
UPDATE public.games 
SET status = NEW.status,
    is_published = CASE WHEN NEW.status = 'approved' THEN true ELSE false END,
    reviewed_by = NEW.moderator_id,
    reviewed_at = now(),
    rejection_reason = NEW.rejection_reason
WHERE id = NEW.content_id;
```

### 额外的保护措施

1. **创建自动同步触发器**：确保 `status` 和 `is_published` 始终保持一致
2. **修复现有数据**：将已经 `status='approved'` 但 `is_published=false` 的游戏修复
3. **更新 RLS 策略**：确保已发布的游戏对所有人可见

## 修复步骤

### 步骤 1：备份数据（可选但推荐）

在 Supabase SQL Editor 中运行：

```sql
-- 查看当前游戏状态
SELECT id, title, status, is_published, created_at 
FROM public.games 
ORDER BY created_at DESC;

-- 备份到临时表（可选）
CREATE TABLE games_backup AS SELECT * FROM public.games;
```

### 步骤 2：运行修复脚本

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单的 **SQL Editor**
4. 创建一个新查询
5. 复制 `fix-approval-status-sync.sql` 文件的**全部内容**
6. 粘贴到 SQL Editor 中
7. 点击 **Run** 按钮执行

### 步骤 3：验证修复结果

执行脚本后，你会看到类似这样的输出：

```
✓ is_published 字段已存在
✓ 已更新 handle_moderation_decision() 触发器函数
✓ 已创建自动同步触发器 trigger_sync_game_publication
✓ 已同步现有游戏的 is_published 状态
✓ 已创建索引
✓ 已更新 RLS 策略
========================================
修复完成！统计信息：
  总游戏数: 22
  已发布游戏数 (is_published=true): 22
  已审核通过游戏数 (status=approved): 22
  状态不同步的游戏数: 0
========================================
✓ 所有游戏的 status 和 is_published 已同步
```

脚本还会显示最近10条游戏的状态：

```
id                                   | title        | status   | is_published | sync_status | created_at
-------------------------------------|--------------|----------|--------------|-------------|------------------
abc123...                            | 示例游戏1    | approved | true         | ✓ 同步      | 2025-11-04 12:00
def456...                            | 示例游戏2    | pending  | false        | ✓ 同步      | 2025-11-03 10:30
```

### 步骤 4：测试审核流程

1. 让普通用户提交一个新游戏
2. 审核员登录审核后台
3. 批准该游戏
4. 在数据库中查询该游戏：
   ```sql
   SELECT status, is_published FROM public.games WHERE title = '新提交的游戏';
   ```
5. 应该看到：`status = 'approved'` 且 `is_published = true`

### 步骤 5：清除前端缓存

1. 在浏览器中打开你的游戏网站
2. 按 `Ctrl + Shift + R`（Windows）或 `Cmd + Shift + R`（Mac）强制刷新
3. 或者清除浏览器缓存后重新登录

## 技术细节

### 修复了哪些文件？

1. **`message-system-setup.sql`**
   - 更新了 `handle_moderation_decision()` 触发器函数
   - 添加了 `is_published` 字段的同步逻辑

2. **`fix-approval-status-sync.sql`**（新建）
   - 完整的修复脚本
   - 包含数据修复、触发器创建、索引优化、RLS策略更新

### 新增的触发器

**`trigger_sync_game_publication`**
- 类型：BEFORE INSERT OR UPDATE 触发器
- 作用：在 `games` 表插入或更新记录前，自动根据 `status` 字段设置 `is_published` 字段
- 规则：
  - `status = 'approved'` → `is_published = true`
  - `status IN ('pending', 'rejected')` → `is_published = false`

### 更新的RLS策略

```sql
CREATE POLICY "games_select_public" ON public.games
  FOR SELECT USING (
    is_published = true OR                    -- 所有人可查看已发布的游戏
    creator = auth.uid() OR                   -- 创建者可查看自己的游戏
    EXISTS (                                  -- 审核员可查看所有游戏
      SELECT 1 FROM public.profiles 
      WHERE id = auth.uid() AND is_moderator = true
    )
  );
```

## 预防措施

### 1. 代码层面

**在 `Moderation.vue` 中**，确保插入游戏时同时设置两个字段：

```javascript
await supabase.from('games').insert([{
  // ... 其他字段
  status: 'approved',        // ← 必须设置
  is_published: true,        // ← 必须设置
  reviewed_by: store.user?.id,
  reviewed_at: new Date().toISOString()
}])
```

### 2. 数据库层面

**触发器自动同步**：
- `trigger_sync_game_publication` 触发器会确保 `status` 和 `is_published` 始终保持一致
- 即使前端代码忘记设置，触发器也会自动修正

### 3. 定期检查

运行此查询检查是否有不同步的记录：

```sql
SELECT 
  id, 
  title, 
  status, 
  is_published,
  CASE 
    WHEN status = 'approved' AND is_published = false THEN '❌ 不同步'
    WHEN status IN ('pending', 'rejected') AND is_published = true THEN '❌ 不同步'
    ELSE '✓ 正常'
  END AS check_result
FROM public.games
WHERE 
  (status = 'approved' AND is_published = false)
  OR (status IN ('pending', 'rejected') AND is_published = true);
```

如果有结果，说明仍然存在问题，需要重新运行修复脚本。

## 常见问题

### Q1: 修复脚本可以重复执行吗？

**A:** 可以。脚本是幂等的，使用了 `CREATE OR REPLACE` 和 `IF EXISTS` 等语句，多次执行不会出错。

### Q2: 已经批准的游戏会被修复吗？

**A:** 会的。脚本的第4步会自动将所有 `status='approved'` 但 `is_published=false` 的游戏更新为 `is_published=true`。

### Q3: 需要修改前端代码吗？

**A:** 不需要。`Moderation.vue` 的代码已经是正确的（同时设置了 `status` 和 `is_published`）。问题出在数据库触发器上，修复数据库后前端代码无需改动。

### Q4: 如果 `games` 表没有 `is_published` 字段怎么办？

**A:** 修复脚本的第1步会自动检查并添加该字段。如果字段不存在，会自动创建；如果已存在，则跳过。

### Q5: 修复后还是看不到游戏？

**A:** 可能的原因：
1. 浏览器缓存：清除缓存或强制刷新（Ctrl+Shift+R）
2. RLS策略问题：检查用户是否登录、是否有查看权限
3. 前端查询条件：检查前端代码是否正确查询 `is_published=true` 的游戏

运行此查询检查游戏是否真的被发布：
```sql
SELECT id, title, is_published FROM public.games WHERE is_published = true;
```

## 总结

这个问题是由于**数据库触发器和前端代码的状态同步不一致**导致的。修复方案包括：

1. ✅ 更新触发器函数，确保审核时同步更新 `is_published`
2. ✅ 创建自动同步触发器，确保 `status` 和 `is_published` 始终一致
3. ✅ 修复现有数据，将已批准的游戏正确标记为已发布
4. ✅ 更新 RLS 策略，确保已发布的游戏对所有人可见

修复后，审核流程应该正常工作，审核员批准的游戏会立即在前台显示。

---

**创建日期**：2025年11月4日  
**修复脚本**：`fix-approval-status-sync.sql`  
**相关文件**：`message-system-setup.sql`, `Moderation.vue`

