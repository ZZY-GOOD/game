# 审核拒绝游戏错误修复指南

## 问题描述

当审核员在审核系统中拒绝游戏时，控制台报错：

```
PATCH https://zfpnrvxduvtckrnwghia.supabase.co/rest/v1/moderation_queue?id=eq.xxx 400 (Bad Request)

审核拒绝失败: {
  code: '23502',
  details: 'Failing row contains (...)',
  hint: null,
  message: 'null value in column "content" of relation "messages" violates not-null constraint'
}
```

## 错误原因

触发器函数 `handle_moderation_decision()` 在处理 `game_submission` 类型的审核时，没有正确生成消息内容，导致插入 `messages` 表时 `content` 字段为 NULL，违反了非空约束。

具体原因：
1. 原始触发器函数的 CASE 语句只处理 `'game'` 和 `'post'` 类型
2. 当 `content_type` 为 `'game_submission'` 时，CASE 语句返回 NULL
3. `messages` 表的 `content` 字段有 NOT NULL 约束，导致插入失败

## 修复步骤

### 步骤 1：打开 Supabase SQL Editor

1. 登录到 [Supabase Dashboard](https://app.supabase.com)
2. 选择您的项目
3. 点击左侧菜单中的 **SQL Editor**

### 步骤 2：执行修复脚本

1. 在 SQL Editor 中，点击 **New query** 创建新查询
2. 复制 `fix-rejection-message-error.sql` 文件的全部内容
3. 粘贴到 SQL Editor 中
4. 点击右下角的 **Run** 按钮执行脚本

### 步骤 3：验证修复结果

执行成功后，您应该看到：

```
status: "fix-rejection-message-error.sql 执行成功！"
message: "现在审核员拒绝游戏时应该不会再报错了。"
```

### 步骤 4：测试功能

1. 返回游戏网站的审核页面
2. 尝试拒绝一个待审核的游戏
3. 填写拒绝原因并确认
4. 验证操作是否成功，不再出现错误

## 修复内容说明

此修复脚本包含以下改动：

### 1. 更新触发器函数
- 修改 `handle_moderation_decision()` 函数
- 添加对 `'game_submission'` 类型的支持
- 使用 `COALESCE` 确保消息内容不为 NULL

### 2. 更新表约束
- 更新 `moderation_queue` 表的 `content_type` 约束，允许 `'game_submission'`
- 更新 `messages` 表的 `related_content_type` 约束，允许 `'game_submission'`

### 3. 完善 RLS 策略
- 确保普通用户可以插入自己的审核记录
- 确保审核员可以查看和更新审核队列

### 4. 优化索引
- 添加必要的索引以提升查询性能

## 预期效果

修复后：

1. ✅ 审核员拒绝游戏时不再报错
2. ✅ 系统自动向提交者发送拒绝通知消息
3. ✅ 消息中包含拒绝原因（如果提供了的话）
4. ✅ 拒绝的游戏从待审核列表移至已处理列表

## 消息示例

### 拒绝消息格式
```
很抱歉，您提交的游戏未通过审核。原因：[拒绝原因]
```

### 通过消息格式
```
恭喜！您提交的游戏已通过审核并发布。
```

## 故障排除

### 如果脚本执行失败

1. **检查权限**：确保您有数据库的修改权限
2. **检查依赖**：确保 `profiles`、`messages`、`moderation_queue` 表已存在
3. **查看错误信息**：SQL Editor 会显示具体的错误信息

### 如果修复后仍有问题

1. 刷新浏览器页面
2. 清除浏览器缓存
3. 检查控制台是否还有其他错误
4. 验证 `send_system_message` 函数是否存在

## 技术细节

### 修改的数据库对象

- **函数**：`handle_moderation_decision()`
- **触发器**：`moderation_decision_trigger`
- **约束**：
  - `moderation_queue.content_type` 约束
  - `messages.related_content_type` 约束
- **策略**：
  - `mq_insert_submitter`
  - `moderation_queue_select_moderators`
  - `moderation_queue_update_moderators`

### 相关代码文件

- **前端**：`src/components/Moderation.vue` (第362-399行)
- **数据库**：
  - `message-system-setup.sql` (原始触发器)
  - `moderation_queue_fix.sql` (部分修复)
  - `moderation_messages_fix.sql` (部分修复)
  - `fix-rejection-message-error.sql` (完整修复) ⭐

## 注意事项

1. 此脚本使用事务（BEGIN/COMMIT），如果任何步骤失败，所有更改都会回滚
2. 脚本是幂等的，可以安全地多次执行
3. 建议在非高峰时段执行，避免影响正在进行的审核操作
4. 执行前建议备份数据库（虽然此脚本只修改结构和函数，不修改数据）

## 相关文档

- [Supabase 触发器文档](https://supabase.com/docs/guides/database/postgres/triggers)
- [PostgreSQL 约束文档](https://www.postgresql.org/docs/current/ddl-constraints.html)
- [RLS 策略配置](https://supabase.com/docs/guides/auth/row-level-security)

## 联系支持

如果在执行过程中遇到任何问题，请：
1. 保存完整的错误信息
2. 截图 SQL Editor 中的错误提示
3. 记录执行的具体步骤

---

**最后更新时间**：2025-11-05

